<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司備忘錄系統 (備註升級版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        .login-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .badge-admin { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-operator { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; }
        .status-border-pending { border-left: 5px solid #f97316; } 
        .status-border-processing { border-left: 5px solid #3b82f6; } 
        .status-border-completed { border-left: 5px solid #22c55e; } 
        #quickPreviewTooltip { transition: opacity 0.2s; pointer-events: none; backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <input type="file" id="restoreInput" accept=".xlsx, .xls, .json" class="hidden" onchange="window.handleRestoreFile(this)">

    <div id="quickPreviewTooltip" class="fixed hidden z-[100] bg-gray-900/95 text-white text-sm p-4 rounded-lg shadow-2xl max-w-sm border border-gray-700 leading-relaxed">
        <div id="tooltipHeader" class="font-bold text-blue-300 mb-2 border-b border-gray-600 pb-2 text-base"></div>
        <div id="tooltipContent" class="space-y-3"></div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center">
            <div class="mb-6"><i class="fas fa-user-shield text-blue-600 text-5xl"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">公司備忘錄系統</h2>
            <p class="text-gray-500 mb-8 text-sm">請使用公司授權的 Google 帳號登入</p>
            <button onclick="window.loginWithGoogle()" class="w-full border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 font-bold py-3 px-4 rounded flex items-center justify-center transition shadow-sm group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-3">
                <span id="loginBtnText">使用 Google 帳號登入</span>
            </button>
            <p id="loginMsg" class="mt-4 text-red-500 text-sm font-bold min-h-[20px]"></p>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav class="bg-white shadow-sm p-4 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800"><i class="fas fa-cloud text-blue-500 mr-2"></i>備忘錄系統</h1>
                <div class="text-gray-500 text-sm flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <img id="userAvatar" src="" class="w-8 h-8 rounded-full border border-gray-200">
                        <div class="flex flex-col items-start leading-tight">
                            <span id="userName" class="font-medium text-gray-700">User</span>
                            <span id="userRoleBadge" class="text-[10px] px-1 rounded bg-gray-100 text-gray-500">載入中</span>
                        </div>
                    </div>
                    
                    <div id="adminControls" class="hidden items-center gap-2">
                        <button onclick="window.openLogModal()" class="bg-gray-100 text-gray-600 hover:bg-gray-200 border border-gray-300 px-3 py-1 rounded text-xs font-bold flex items-center" title="操作日誌">
                            <i class="fas fa-history mr-1"></i> 日誌
                        </button>

                        <button onclick="window.openEmployeeModal()" class="bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-3 py-1 rounded text-xs font-bold flex items-center">
                            <i class="fas fa-users-cog mr-1"></i> 權限
                        </button>
                        <div class="relative group">
                            <button class="bg-green-50 text-green-600 hover:bg-green-100 border border-green-200 px-3 py-1 rounded text-xs font-bold flex items-center">
                                <i class="fas fa-database mr-1"></i> 資料庫 <i class="fas fa-chevron-down ml-1"></i>
                            </button>
                            <div class="absolute right-0 mt-0 w-56 bg-white rounded-md shadow-lg border border-gray-200 hidden group-hover:block z-50">
                                <div class="px-4 py-2 text-xs font-bold text-gray-400 bg-gray-50 border-b">備份 (匯出)</div>
                                <a href="#" onclick="window.backupToExcel()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700"><i class="fas fa-file-excel mr-2 text-green-600"></i> 下載 Excel 檔</a>
                                <a href="#" onclick="window.backupToJson()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700"><i class="fas fa-file-code mr-2 text-blue-600"></i> 下載 JSON 檔</a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <div class="px-4 py-2 text-xs font-bold text-gray-400 bg-gray-50 border-b">還原 (匯入)</div>
                                <a href="#" onclick="document.getElementById('restoreInput').click()" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i class="fas fa-upload mr-2"></i> 還原資料</a>
                            </div>
                        </div>
                    </div>
                    <button onclick="window.logout()" class="text-gray-500 hover:text-gray-700 text-xs border border-gray-200 px-2 py-1 rounded">登出</button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <div id="dashboardView">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800">客戶備忘錄列表</h2>
                    <div class="flex gap-2">
                        <button onclick="window.toggleView('clientManager')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-50 transition shadow-sm text-sm font-bold flex items-center">
                            <i class="fas fa-cog mr-2 text-gray-500"></i> 客戶管理
                        </button>
                        <button onclick="window.openMemoModal()" class="bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-800 transition flex items-center shadow-md">
                            <i class="fas fa-plus mr-2"></i> 新增備忘錄
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row gap-4">
                    <div class="relative flex-grow">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="搜尋客戶代號或名稱..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="flex items-center">
                        <span class="mr-2 text-gray-600">排序方式:</span>
                        <select id="sortSelect" class="border border-gray-200 rounded px-3 py-2 focus:outline-none bg-white">
                            <option value="code">客戶編號 (預設)</option>
                            <option value="pending" class="text-orange-600 font-bold">⚠ 未處理優先</option>
                            <option value="processing" class="text-blue-600 font-bold">⟳ 處理中優先</option>
                            <option value="completed" class="text-green-600 font-bold">✓ 已完成優先</option>
                        </select>
                    </div>
                </div>

                <div id="clientCardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="clientDetailView" class="hidden">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="window.closeClientDetail()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded-full flex items-center justify-center transition">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800" id="detailClientName">客戶名稱</h2>
                            <p class="text-sm text-gray-500 font-mono" id="detailClientCode">代號</p>
                        </div>
                    </div>
                    <button onclick="window.openMemoModal(null, true)" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition shadow-sm">
                        <i class="fas fa-plus mr-2"></i> 新增紀錄
                    </button>
                </div>
                <div id="memoListContainer" class="space-y-4 max-w-4xl mx-auto"></div>
            </div>

            <div id="clientManagerView" class="hidden">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="bg-gray-50 p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i class="fas fa-address-book text-xl"></i></div>
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">客戶資料管理</h3>
                                <p class="text-sm text-gray-500">管理系統中的所有客戶名單</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.toggleView('dashboard')" class="bg-white text-gray-600 border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-50 transition shadow-sm font-bold flex items-center"><i class="fas fa-arrow-left mr-2"></i> 返回列表</button>
                            <button onclick="window.openClientModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md font-bold flex items-center"><i class="fas fa-plus mr-2"></i> 新增客戶</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="bg-gray-100 text-gray-500 uppercase text-xs tracking-wider font-semibold border-b border-gray-200">
                                    <th class="p-5 pl-8">客戶資訊</th>
                                    <th class="p-5">客戶代號</th>
                                    <th class="p-5 text-right pr-8">操作</th>
                                </tr>
                            </thead>
                            <tbody id="manageClientTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="memoModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-screen">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold" id="memoModalTitle">新增備忘錄</p>
                    <div class="cursor-pointer z-50" onclick="window.closeModal('memoModal')"><i class="fas fa-times text-gray-500"></i></div>
                </div>
                <form id="memoForm" onsubmit="event.preventDefault(); window.saveMemo()">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">選擇客戶</label>
                        <select id="memoClientSelect" class="w-full border border-gray-300 rounded px-3 py-2 bg-blue-50" required onchange="window.updateMemoClientDisplay()"></select>
                    </div>
                    <div id="selectedClientDisplay" class="mb-4 p-3 bg-blue-50 text-blue-800 rounded border border-blue-100 hidden">已選擇: <span id="displayClientCode"></span> - <span id="displayClientName"></span></div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">備忘事項內容 (主旨)</label>
                        <textarea id="memoContent" class="w-full border border-gray-300 rounded px-3 py-2 h-24" placeholder="例如：提醒繳交文件..." required></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">進度狀態</label>
                        <select id="memoStatus" class="w-full border border-gray-300 rounded px-3 py-2"><option value="pending">○ 尚未完成</option><option value="processing">⟳ 處理中</option><option value="completed">✓ 已完成</option></select>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <div class="bg-blue-50 p-3 rounded border border-blue-100">
                            <label class="block text-blue-800 text-sm font-bold mb-2"><i class="fas fa-comment-dots mr-1"></i> 客戶回覆</label>
                            <textarea id="memoFeedback" class="w-full border border-blue-200 rounded px-3 py-2 h-16 bg-white focus:ring-1 focus:ring-blue-300 outline-none" placeholder="客戶說..."></textarea>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded border border-yellow-100">
                            <label class="block text-yellow-800 text-sm font-bold mb-2"><i class="fas fa-sticky-note mr-1"></i> 內部備註 (細項)</label>
                            <textarea id="memoRemark" class="w-full border border-yellow-200 rounded px-3 py-2 h-16 bg-white focus:ring-1 focus:ring-yellow-300 outline-none" placeholder="公司內部註記..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-between pt-2">
                        <button type="button" id="deleteMemoBtn" onclick="window.deleteMemo()" class="hidden bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded font-bold transition">
                            <i class="fas fa-trash-alt mr-1"></i> 刪除
                        </button>
                        <button type="submit" id="saveMemoBtn" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-6 rounded transition ml-auto">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="clientModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3"><p class="text-xl font-bold" id="clientModalTitle">新增客戶</p><div class="cursor-pointer" onclick="window.closeModal('clientModal')"><i class="fas fa-times text-gray-500"></i></div></div>
                <form onsubmit="event.preventDefault(); window.saveClient()">
                    <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">客戶代號 (ID)</label><input id="newClientCode" type="text" class="w-full border border-gray-300 rounded px-3 py-2 outline-none" placeholder="例如: C002" required></div>
                    <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">客戶名稱</label><input id="newClientName" type="text" class="w-full border border-gray-300 rounded px-3 py-2 outline-none" placeholder="例如: XYZ 公司" required></div>
                    <div class="flex justify-end gap-2"><button type="button" onclick="window.closeModal('clientModal')" class="bg-white border text-gray-700 px-4 py-2 rounded">取消</button><button type="submit" id="saveClientBtn" class="bg-blue-600 text-white px-4 py-2 rounded">新增</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="employeeModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b mb-4"><p class="text-xl font-bold text-gray-800"><i class="fas fa-user-shield mr-2"></i>員工權限管理</p><div class="cursor-pointer" onclick="window.closeModal('employeeModal')"><i class="fas fa-times text-gray-500"></i></div></div>
                <form onsubmit="event.preventDefault(); window.saveEmployee()" class="bg-red-50 p-4 rounded mb-6 border border-red-100">
                    <h4 class="text-sm font-bold text-red-800 mb-3"><i class="fas fa-plus-circle mr-1"></i> 新增/修改 員工白名單</h4>
                    <div class="flex flex-col md:flex-row gap-3">
                        <input id="empEmail" type="email" placeholder="Google Email" class="flex-[2] border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-200 outline-none" required>
                        <input id="empName" type="text" placeholder="姓名/備註" class="flex-1 border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-red-200 outline-none" required>
                        <select id="empRole" class="flex-1 border rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-red-200 outline-none"><option value="operator">操作員</option><option value="admin">管理員</option></select>
                        <button type="submit" id="saveEmpBtn" class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700 whitespace-nowrap font-bold"><i class="fas fa-save mr-1"></i> 儲存</button>
                    </div>
                </form>
                <div class="max-h-64 overflow-y-auto border border-gray-100 rounded"><table class="w-full text-left text-sm"><thead class="bg-gray-50 text-gray-600 sticky top-0"><tr><th class="p-3">姓名</th><th class="p-3">Email</th><th class="p-3">職位</th><th class="p-3 text-right">操作</th></tr></thead><tbody id="employeeTableBody"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="logModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded shadow-lg z-50 h-[80vh] flex flex-col">
            <div class="modal-content py-4 text-left px-6 border-b flex justify-between items-center">
                <p class="text-xl font-bold text-gray-800"><i class="fas fa-history mr-2 text-gray-500"></i>系統操作日誌 (Audit Logs)</p>
                <div class="cursor-pointer" onclick="window.closeModal('logModal')"><i class="fas fa-times text-gray-500"></i></div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="logContainer">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-200 text-gray-600 sticky top-0">
                        <tr>
                            <th class="p-3">時間</th>
                            <th class="p-3">操作人員</th>
                            <th class="p-3">動作</th>
                            <th class="p-3">詳細內容</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, updateDoc, writeBatch, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, getDoc, getDocs, Timestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvo1Q_O9Mxp-N3bbUQlTppXxc_h5Ame-E",
            authDomain: "notes-8be76.firebaseapp.com",
            projectId: "notes-8be76",
            storageBucket: "notes-8be76.firebasestorage.app",
            messagingSenderId: "1036855189662",
            appId: "1:1036855189662:web:4863ff65f63ab00a995b8f",
            measurementId: "G-KMB6Q7VK8Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let clientsData = [];
        let memosData = [];
        let unsubscribeClients = null;
        let unsubscribeMemos = null;
        let currentUserEmail = "";
        let currentUserRole = "operator";
        let editingMemoId = null;
        let editingClientCode = null;

        async function logAction(action, details) {
            try {
                await addDoc(collection(db, "logs"), {
                    action: action,
                    details: details,
                    user: currentUserEmail,
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Log error", e); }
        }

        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            if (user) {
                try {
                    const whitelistRef = doc(db, "whitelist", user.email);
                    const whitelistSnap = await getDoc(whitelistRef);
                    if (whitelistSnap.exists()) {
                        const userData = whitelistSnap.data();
                        currentUserEmail = user.email;
                        currentUserRole = userData.role || 'operator';
                        loginScreen.classList.add('hidden'); loginScreen.classList.remove('flex'); mainApp.classList.remove('hidden');
                        document.getElementById('userName').innerText = userData.name || user.email;
                        document.getElementById('userAvatar').src = user.photoURL;
                        const roleBadge = document.getElementById('userRoleBadge');
                        const adminControls = document.getElementById('adminControls');
                        if (currentUserRole === 'admin') {
                            roleBadge.innerText = "管理員";
                            roleBadge.className = "text-[10px] px-1 rounded badge-admin font-bold";
                            adminControls.classList.remove('hidden'); adminControls.classList.add('flex');
                        } else {
                            roleBadge.innerText = "操作員";
                            roleBadge.className = "text-[10px] px-1 rounded badge-operator font-bold";
                            adminControls.classList.add('hidden'); adminControls.classList.remove('flex');
                        }
                        startListeners();
                    } else { throw new Error("不在白名單內"); }
                } catch (error) { alert("登入失敗：無權限"); signOut(auth); }
            } else { loginScreen.classList.remove('hidden'); loginScreen.classList.add('flex'); mainApp.classList.add('hidden'); }
        });

        window.loginWithGoogle = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.logout = () => signOut(auth).then(() => location.reload());

        function startListeners() {
            const qClients = query(collection(db, "clients"), orderBy("code"));
            unsubscribeClients = onSnapshot(qClients, (snapshot) => {
                clientsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
            const qMemos = query(collection(db, "memos"), orderBy("timestamp", "desc"));
            unsubscribeMemos = onSnapshot(qMemos, (snapshot) => {
                memosData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }
        function renderAll() {
            window.renderDashboard();
            window.renderClientManager();
            window.renderClientSelect();
            const detailView = document.getElementById('clientDetailView');
            if (!detailView.classList.contains('hidden')) {
                const currentCode = document.getElementById('detailClientCode').innerText;
                window.openClientDetail(currentCode);
            }
        }

        window.renderDashboard = function() {
            const container = document.getElementById('clientCardContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sortMode = document.getElementById('sortSelect').value;
            container.innerHTML = '';
            
            const clientStats = clientsData.map(client => {
                if (!client.name.toLowerCase().includes(search) && !client.code.toLowerCase().includes(search)) return null;
                const clientMemos = memosData.filter(m => m.clientCode === client.code);
                return {
                    ...client,
                    pendingCount: clientMemos.filter(m => m.status === 'pending').length,
                    processingCount: clientMemos.filter(m => m.status === 'processing').length,
                    completedCount: clientMemos.filter(m => m.status === 'completed').length
                };
            }).filter(c => c !== null);

            clientStats.sort((a, b) => {
                if (sortMode === 'pending') { const aH = a.pendingCount>0; const bH = b.pendingCount>0; if(aH!=bH) return aH?-1:1; }
                else if (sortMode === 'processing') { const aH = a.processingCount>0; const bH = b.processingCount>0; if(aH!=bH) return aH?-1:1; }
                else if (sortMode === 'completed') { const aH = a.completedCount>0; const bH = b.completedCount>0; if(aH!=bH) return aH?-1:1; }
                return a.code.localeCompare(b.code);
            });

            clientStats.forEach(client => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-xl border border-gray-200 hover:shadow-lg transition cursor-pointer group relative overflow-hidden";
                card.onclick = () => window.openClientDetail(client.code);
                
                const pendingClass = client.pendingCount > 0 ? "text-orange-600 font-bold hover:bg-orange-50 cursor-help rounded px-1 transition" : "text-gray-400";
                const processingClass = client.processingCount > 0 ? "text-blue-600 font-bold hover:bg-blue-50 cursor-help rounded px-1 transition" : "text-gray-400";
                const completedClass = client.completedCount > 0 ? "text-green-600 font-bold hover:bg-green-50 cursor-help rounded px-1 transition" : "text-gray-400";

                card.innerHTML = `
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition"><i class="fas fa-folder text-6xl text-blue-500"></i></div>
                    <div class="flex justify-between items-start mb-4"><div><h3 class="text-xl font-bold text-gray-800 mb-1 group-hover:text-blue-600 transition">${client.name}</h3><span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded font-mono">${client.code}</span></div></div>
                    <div class="space-y-2 mt-4 relative">
                        <div class="flex justify-between items-center text-sm" onmouseenter="window.showPreview(event, '${client.code}', 'pending')" onmouseleave="window.hidePreview()"><span class="text-gray-500"><i class="far fa-circle text-orange-500 mr-2"></i>未完成</span><span class="${pendingClass}">${client.pendingCount}</span></div>
                        <div class="flex justify-between items-center text-sm" onmouseenter="window.showPreview(event, '${client.code}', 'processing')" onmouseleave="window.hidePreview()"><span class="text-gray-500"><i class="fas fa-sync text-blue-500 mr-2"></i>處理中</span><span class="${processingClass}">${client.processingCount}</span></div>
                        <div class="flex justify-between items-center text-sm" onmouseenter="window.showPreview(event, '${client.code}', 'completed')" onmouseleave="window.hidePreview()"><span class="text-gray-500"><i class="fas fa-check text-green-500 mr-2"></i>已完成</span><span class="${completedClass}">${client.completedCount}</span></div>
                    </div>
                `;
                container.appendChild(card);
            });
            if(container.innerHTML === '') container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400">查無資料</div>`;
        }

        window.showPreview = function(event, clientCode, status) {
            const targetMemos = memosData.filter(m => m.clientCode === clientCode && m.status === status);
            if (targetMemos.length === 0) return;
            const tooltip = document.getElementById('quickPreviewTooltip');
            const header = document.getElementById('tooltipHeader');
            const content = document.getElementById('tooltipContent');
            let titleText = "", colorClass = "";
            if(status === 'pending') { titleText = "未完成事項"; colorClass = "text-orange-300"; }
            else if(status === 'processing') { titleText = "處理中事項"; colorClass = "text-blue-300"; }
            else { titleText = "已完成事項"; colorClass = "text-green-300"; }
            header.className = `font-bold mb-2 border-b border-gray-600 pb-2 text-base ${colorClass}`;
            header.innerText = `${titleText} (${targetMemos.length})`;
            
            content.innerHTML = targetMemos.slice(0, 5).map(m => {
                let dateStr = m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleDateString() : '';
                return `<div class="flex gap-2 items-start"><span class="text-gray-500 whitespace-nowrap font-mono text-xs mt-0.5">${dateStr}</span><span class="line-clamp-2">${m.content}</span></div>`;
            }).join('');
            
            if(targetMemos.length > 5) content.innerHTML += `<div class="text-center text-gray-500 italic mt-1">...還有 ${targetMemos.length - 5} 筆</div>`;
            tooltip.classList.remove('hidden');
            const x = event.clientX + 15; const y = event.clientY + 15;
            const rect = tooltip.getBoundingClientRect();
            tooltip.style.left = (x + rect.width > window.innerWidth ? event.clientX - rect.width - 10 : x) + 'px';
            tooltip.style.top = (y + rect.height > window.innerHeight ? event.clientY - rect.height - 10 : y) + 'px';
        }
        window.hidePreview = () => document.getElementById('quickPreviewTooltip').classList.add('hidden');

        // --- [修改] Detail Render Logic ---
        window.openClientDetail = function(code) {
            const client = clientsData.find(c => c.code === code); if (!client) return;
            document.getElementById('detailClientName').innerText = client.name;
            document.getElementById('detailClientCode').innerText = client.code;
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('clientDetailView').classList.remove('hidden');
            document.getElementById('clientManagerView').classList.add('hidden');
            const container = document.getElementById('memoListContainer');
            container.innerHTML = '';
            const clientMemos = memosData.filter(m => m.clientCode === code);
            clientMemos.forEach(memo => {
                let timeStr = memo.timestamp ? (memo.timestamp.toDate ? memo.timestamp.toDate() : new Date(memo.timestamp)).toLocaleString('zh-TW', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
                let statusText = "", statusClass = "", icon = "";
                switch(memo.status) {
                    case 'completed': statusText = "已完成"; statusClass = "status-border-completed"; icon="fa-check text-green-500"; break;
                    case 'processing': statusText = "處理中"; statusClass = "status-border-processing"; icon="fa-sync text-blue-500"; break;
                    default: statusText = "尚未完成"; statusClass = "status-border-pending"; icon="fa-circle text-orange-500"; break;
                }
                
                // 客戶回覆 (藍色)
                const feedbackHtml = memo.feedback 
                    ? `<div class="mt-3 bg-blue-50 p-3 rounded text-sm border border-blue-100"><div class="font-bold text-blue-800 mb-1"><i class="fas fa-comment-dots mr-1"></i> 客戶回覆：</div><div class="text-gray-800">${memo.feedback}</div></div>` 
                    : ``;

                // 內部備註 (黃色) - 如果有備註才顯示
                const remarkHtml = memo.remark
                    ? `<div class="mt-3 bg-yellow-50 p-3 rounded text-sm border border-yellow-100"><div class="font-bold text-yellow-800 mb-1"><i class="fas fa-sticky-note mr-1"></i> 內部備註：</div><div class="text-gray-800">${memo.remark}</div></div>`
                    : ``;

                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-lg shadow-sm border border-gray-100 ${statusClass} hover:shadow-md transition relative`;
                card.innerHTML = `
                    <button onclick="window.editMemo('${memo.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-blue-600 transition p-2 bg-gray-50 rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-pen text-sm"></i></button>
                    <div class="flex justify-between items-start mb-2 pr-10">
                        <span class="text-xs text-gray-400 font-mono">${timeStr}</span>
                        <div class="flex items-center gap-1 text-sm font-bold text-gray-700"><i class="fas ${icon} text-xs"></i> ${statusText}</div>
                    </div>
                    <div class="text-gray-800 text-lg mb-2 whitespace-pre-wrap">${memo.content}</div>
                    ${feedbackHtml}
                    ${remarkHtml}
                `;
                container.appendChild(card);
            });
        }
        window.closeClientDetail = function() {
            document.getElementById('clientDetailView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
        }

        // --- [修改] Modal & Edit ---
        window.openMemoModal = function(memoData = null, lock = false) {
            const modal = document.getElementById('memoModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            const select = document.getElementById('memoClientSelect');
            const deleteBtn = document.getElementById('deleteMemoBtn');
            
            if(memoData) {
                editingMemoId = memoData.id;
                document.getElementById('memoModalTitle').innerText = "編輯備忘錄";
                document.getElementById('saveMemoBtn').innerText = "更新資料";
                select.value = memoData.clientCode;
                document.getElementById('memoContent').value = memoData.content;
                document.getElementById('memoStatus').value = memoData.status;
                document.getElementById('memoFeedback').value = memoData.feedback || '';
                // [新增] 填入備註
                document.getElementById('memoRemark').value = memoData.remark || '';
                
                select.disabled = true;
                deleteBtn.classList.remove('hidden');
            } else {
                editingMemoId = null;
                document.getElementById('memoModalTitle').innerText = "新增備忘錄";
                document.getElementById('saveMemoBtn').innerText = "保存";
                document.getElementById('memoForm').reset();
                select.disabled = false;
                deleteBtn.classList.add('hidden');
                if(lock) { select.value = document.getElementById('detailClientCode').innerText; select.disabled = true; }
            }
            window.updateMemoClientDisplay();
        }
        window.editMemo = (id) => { const m = memosData.find(x => x.id === id); if(m) window.openMemoModal(m); }
        window.closeModal = (id) => document.getElementById(id).classList.add('opacity-0', 'pointer-events-none');
        window.updateMemoClientDisplay = () => {
            const val = document.getElementById('memoClientSelect').value;
            const c = clientsData.find(x => x.code === val);
            if(c) { document.getElementById('selectedClientDisplay').classList.remove('hidden'); document.getElementById('displayClientCode').innerText = c.code; document.getElementById('displayClientName').innerText = c.name; }
        }
        window.toggleView = (v) => {
            document.getElementById('dashboardView').classList.toggle('hidden', v!=='dashboard');
            document.getElementById('clientManagerView').classList.toggle('hidden', v!=='clientManager');
            document.getElementById('clientDetailView').classList.add('hidden');
        }

        // --- [修改] Save Logic (包含 remark) ---
        window.saveMemo = async function() {
            const clientCode = document.getElementById('memoClientSelect').value;
            const content = document.getElementById('memoContent').value;
            const status = document.getElementById('memoStatus').value;
            const feedback = document.getElementById('memoFeedback').value;
            // [新增] 取得備註
            const remark = document.getElementById('memoRemark').value;

            if(!clientCode) return alert('請選擇客戶');
            const btn = document.getElementById('saveMemoBtn'); btn.disabled=true;
            try {
                if(editingMemoId) {
                    // 更新時加入 remark
                    await updateDoc(doc(db, "memos", editingMemoId), { content, status, feedback, remark });
                    await logAction("更新備忘錄", `客戶:${clientCode}, 狀態:${status}`);
                } else {
                    // 新增時加入 remark
                    await addDoc(collection(db, "memos"), { clientCode, content, status, feedback, remark, timestamp: serverTimestamp() });
                    await logAction("新增備忘錄", `客戶:${clientCode}`);
                }
                window.closeModal('memoModal');
            } catch(e) { console.error(e); alert("失敗"); } finally { btn.disabled=false; }
        }

        // [刪除功能]
        window.deleteMemo = async function() {
            if(!editingMemoId) return;
            if(!confirm('確定要刪除這條備忘錄嗎？\n此動作無法復原！')) return;
            const btn = document.getElementById('deleteMemoBtn'); btn.disabled = true; btn.innerText = "刪除中...";
            try {
                await deleteDoc(doc(db, "memos", editingMemoId));
                await logAction("刪除備忘錄", `ID:${editingMemoId}`);
                window.closeModal('memoModal');
            } catch(e) { console.error(e); alert("刪除失敗"); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> 刪除'; }
        }

        window.openClientModal = function(data = null) {
            const modal = document.getElementById('clientModal'); modal.classList.remove('opacity-0', 'pointer-events-none');
            const codeInput = document.getElementById('newClientCode');
            const nameInput = document.getElementById('newClientName');
            codeInput.value=''; nameInput.value=''; codeInput.disabled=false; codeInput.classList.remove('bg-gray-100','cursor-not-allowed');
            if(data) {
                editingClientCode = data.code;
                document.getElementById('clientModalTitle').innerText = "編輯客戶";
                document.getElementById('saveClientBtn').innerText = "儲存修改";
                codeInput.value = data.code; nameInput.value = data.name;
                codeInput.disabled=true; codeInput.classList.add('bg-gray-100','cursor-not-allowed');
            } else {
                editingClientCode = null;
                document.getElementById('clientModalTitle').innerText = "新增客戶";
                document.getElementById('saveClientBtn').innerText = "新增";
            }
        }
        window.editClient = (code) => { const c = clientsData.find(x => x.code === code); if(c) window.openClientModal(c); }
        
        window.saveClient = async function() {
            const code = document.getElementById('newClientCode').value.trim();
            const name = document.getElementById('newClientName').value.trim();
            if(!code || !name) return;
            const btn = document.getElementById('saveClientBtn'); btn.disabled=true;
            try {
                if(editingClientCode) {
                    await updateDoc(doc(db, "clients", editingClientCode), { name });
                    await logAction("修改客戶", `代號:${code}, 新名稱:${name}`);
                } else {
                    const ref = doc(db, "clients", code);
                    const snap = await getDoc(ref);
                    if(snap.exists()) { alert("重複代號"); btn.disabled=false; return; }
                    await setDoc(ref, { code, name, createdAt: serverTimestamp() });
                    await logAction("新增客戶", `代號:${code}, 名稱:${name}`);
                }
                window.closeModal('clientModal');
            } catch(e) { console.error(e); alert("失敗"); } finally { btn.disabled=false; }
        }
        
        window.deleteClient = async function(code) {
            if(confirm('確定刪除?')) {
                try {
                    await deleteDoc(doc(db, "clients", code));
                    await logAction("刪除客戶", `代號:${code}`);
                } catch(e) { alert("刪除失敗"); }
            }
        }

        window.renderClientManager = function() {
            const tbody = document.getElementById('manageClientTableBody');
            tbody.innerHTML = '';
            clientsData.forEach((client) => {
                const tr = document.createElement('tr');
                tr.className = "group border-b border-gray-100 hover:bg-blue-50 transition duration-150";
                const createdDate = client.createdAt ? new Date(client.createdAt.seconds * 1000).toLocaleDateString() : '未知';
                tr.innerHTML = `<td class="p-5 pl-8"><div class="flex flex-col"><p class="font-bold text-gray-800 text-lg">${client.name}</p><p class="text-xs text-gray-400">建立日期: ${createdDate}</p></div></td><td class="p-5"><span class="bg-gray-100 text-gray-600 border border-gray-200 px-3 py-1 rounded-md font-mono text-sm font-bold shadow-sm">${client.code}</span></td><td class="p-5 pr-8 text-right space-x-2"><button onclick="window.editClient('${client.code}')" class="text-gray-400 hover:text-blue-500 hover:bg-blue-50 p-2 rounded-full transition w-10 h-10 inline-flex items-center justify-center"><i class="fas fa-pen"></i></button><button onclick="window.deleteClient('${client.code}')" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition w-10 h-10 inline-flex items-center justify-center"><i class="fas fa-trash-alt"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        window.renderClientSelect = function() {
            const select = document.getElementById('memoClientSelect');
            select.innerHTML = '<option value="" disabled selected>請選擇客戶</option>';
            clientsData.forEach(c => { const opt = document.createElement('option'); opt.value=c.code; opt.text=`${c.code} - ${c.name}`; select.appendChild(opt); });
        }

        window.openLogModal = async function() {
            if(currentUserRole !== 'admin') return alert('權限不足');
            document.getElementById('logModal').classList.remove('opacity-0', 'pointer-events-none');
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">載入中...</td></tr>';
            try {
                const q = query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50));
                const snap = await getDocs(q);
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : '';
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    tr.innerHTML = `<td class="p-3 text-xs text-gray-500 font-mono">${time}</td><td class="p-3 text-sm font-bold">${log.user}</td><td class="p-3 text-sm"><span class="bg-gray-100 px-2 py-1 rounded">${log.action}</span></td><td class="p-3 text-sm text-gray-600">${log.details}</td>`;
                    tbody.appendChild(tr);
                });
            } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">載入失敗</td></tr>'; }
        }

        window.openEmployeeModal = async function() {
            if (currentUserRole !== 'admin') { alert("權限不足"); return; }
            document.getElementById('employeeModal').classList.remove('opacity-0', 'pointer-events-none');
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center">載入中...</td></tr>';
            try {
                const querySnapshot = await getDocs(collection(db, "whitelist"));
                tbody.innerHTML = '';
                querySnapshot.forEach((docSnap) => {
                    const emp = docSnap.data();
                    const email = docSnap.id;
                    const isSelf = email === currentUserEmail;
                    const role = emp.role || 'operator';
                    const roleLabel = role === 'admin' ? `<span class="badge-admin text-xs px-2 py-1 rounded">管理員</span>` : `<span class="badge-operator text-xs px-2 py-1 rounded">操作員</span>`;
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-gray-100 hover:bg-gray-50";
                    tr.innerHTML = `<td class="p-3 font-bold text-gray-700">${emp.name||'-'}</td><td class="p-3 text-gray-500 font-mono text-xs">${email}</td><td class="p-3">${roleLabel}</td><td class="p-3 text-right">${isSelf ? '<span class="text-xs text-gray-400">你自己</span>' : `<button onclick="window.deleteEmployee('${email}')" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash-alt"></i></button>`}</td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-red-500">載入失敗</td></tr>'; }
        }
        window.saveEmployee = async function() {
            const email = document.getElementById('empEmail').value.trim();
            const name = document.getElementById('empName').value.trim();
            const role = document.getElementById('empRole').value;
            if(!email || !name) return;
            try { 
                await setDoc(doc(db, "whitelist", email), { name, role, addedBy: currentUserEmail, timestamp: serverTimestamp() }); 
                await logAction("新增員工", `Email:${email}, 角色:${role}`);
                document.getElementById('empEmail').value=''; document.getElementById('empName').value=''; window.openEmployeeModal(); 
            } catch(e) { alert("失敗：權限不足"); }
        }
        window.deleteEmployee = async function(email) { 
            if(confirm(`確定要移除 ${email}?`)) try { 
                await deleteDoc(doc(db, "whitelist", email)); 
                await logAction("刪除員工", `Email:${email}`);
                window.openEmployeeModal(); 
            } catch(e) { alert("失敗"); } 
        }

        // --- [修改] Backup Logic (加入 remark) ---
        window.backupToExcel = function() {
            if (currentUserRole !== 'admin') return alert('權限不足');
            try {
                const memoRows = memosData.map(m => ({ 
                    clientCode: m.clientCode, 
                    content: m.content, 
                    status: m.status, 
                    feedback: m.feedback || "", 
                    remark: m.remark || "", // [新增]
                    timestamp: m.timestamp && m.timestamp.toDate ? m.timestamp.toDate().toISOString() : new Date().toISOString() 
                }));
                const clientRows = clientsData.map(c => ({ code: c.code, name: c.name }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clientRows), "客戶資料");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(memoRows), "備忘錄");
                XLSX.writeFile(wb, `backup_excel_${new Date().toISOString().slice(0,10)}.xlsx`);
                logAction("系統備份", "匯出 Excel");
            } catch (e) { console.error(e); alert("匯出失敗"); }
        }
        window.backupToJson = function() {
            if (currentUserRole !== 'admin') return alert('權限不足');
            try {
                const safeMemos = memosData.map(m => { const obj = { ...m }; if(obj.timestamp && obj.timestamp.toDate) obj.timestampISO = obj.timestamp.toDate().toISOString(); delete obj.timestamp; return obj; });
                const payload = { version: "1.0", exportedAt: new Date().toISOString(), data: { clients: clientsData, memos: safeMemos } };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
                const dlNode = document.createElement('a'); dlNode.setAttribute("href", dataStr); dlNode.setAttribute("download", `backup_json_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
                logAction("系統備份", "匯出 JSON");
            } catch (e) { console.error(e); alert("匯出失敗"); }
        }

        // --- [修改] Restore Logic (處理 remark) ---
        window.handleRestoreFile = function(input) {
            const file = input.files[0]; if (!file) return;
            if(!confirm("⚠️ 警告：這將會【清空現有資料】並匯入新內容。\n確定要執行還原嗎？")) { input.value = ''; return; }
            const reader = new FileReader();
            if (file.name.endsWith('.json')) {
                reader.onload = async function(e) {
                    try { const json = JSON.parse(e.target.result); await performRestore(json.data.clients, json.data.memos); } catch (err) { alert("還原失敗 (JSON)"); }
                }; reader.readAsText(file);
            } else {
                reader.onload = async function(e) {
                    const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, {type: 'array'});
                    try {
                        const newClients = XLSX.utils.sheet_to_json(wb.Sheets["客戶資料"]);
                        const newMemos = XLSX.utils.sheet_to_json(wb.Sheets["備忘錄"]);
                        await performRestore(newClients, newMemos);
                    } catch (err) { alert("還原失敗 (Excel)"); }
                }; reader.readAsArrayBuffer(file);
            }
            input.value = '';
        }
        async function performRestore(newClients, newMemos) {
            const batchDel = writeBatch(db);
            const snapC = await getDocs(collection(db, "clients")); snapC.forEach(d => batchDel.delete(d.ref));
            const snapM = await getDocs(collection(db, "memos")); snapM.forEach(d => batchDel.delete(d.ref));
            await batchDel.commit();
            for (const c of newClients) { if(c.code) await setDoc(doc(db, "clients", String(c.code)), { code: String(c.code), name: String(c.name), createdAt: serverTimestamp() }); }
            for (const m of newMemos) {
                let ts = serverTimestamp();
                const timeVal = m.timestampISO || m.timestamp;
                if (timeVal) ts = Timestamp.fromDate(new Date(timeVal));
                // [新增] 寫入 remark
                await addDoc(collection(db, "memos"), { 
                    clientCode: String(m.clientCode), 
                    content: m.content||"", 
                    status: m.status||"pending", 
                    feedback: m.feedback||"", 
                    remark: m.remark||"", 
                    timestamp: ts 
                });
            }
            await logAction("系統還原", `還原 ${newClients.length} 客戶, ${newMemos.length} 備忘錄`);
            alert("還原成功！"); window.location.reload();
        }

        document.getElementById('searchInput').addEventListener('keyup', window.renderDashboard);
        document.getElementById('sortSelect').addEventListener('change', window.renderDashboard);
    </script>
</body>
</html>
