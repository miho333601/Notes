<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料庫重置與匯入工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-800 min-h-screen text-gray-100 p-10">

    <div class="max-w-4xl mx-auto bg-gray-900 p-8 rounded-xl shadow-2xl border border-gray-700">
        <h1 class="text-3xl font-bold mb-2 text-white"><i class="fas fa-database mr-3 text-red-500"></i>資料庫重置與匯入系統</h1>
        <p class="text-gray-400 mb-8 border-b border-gray-700 pb-4">此工具將會 <b>清除所有舊資料</b> 並依照下方列表建立新客戶。</p>
        
        <div id="loginSection" class="text-center py-10">
            <button onclick="login()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold transition text-lg shadow-lg">
                <i class="fab fa-google mr-2"></i> 管理員登入
            </button>
        </div>

        <div id="actionSection" class="hidden space-y-8">
            
            <div>
                <label class="block text-lg font-bold text-blue-400 mb-2">
                    步驟 1：輸入新客戶名單
                </label>
                <p class="text-sm text-gray-400 mb-2">
                    請依照 <b>「代號 客戶名稱」</b> 的格式輸入，一行一筆。<br>
                    例如：<br>
                    <span class="font-mono text-gray-500">S001 台積電<br>S002 聯發科</span>
                </p>
                <textarea id="rawInput" class="w-full h-64 bg-gray-800 text-white p-4 rounded-lg border border-gray-600 font-mono text-sm focus:outline-none focus:border-blue-500" placeholder="在此貼上所有客戶資料..."></textarea>
                <div class="mt-2 text-right text-sm text-gray-500">
                    預計匯入：<span id="countPreview" class="text-white font-bold">0</span> 筆
                </div>
            </div>

            <div class="bg-red-900/30 p-6 rounded-lg border border-red-900/50">
                <label class="block text-lg font-bold text-red-400 mb-4">
                    步驟 2：執行重置與匯入
                </label>
                <div class="flex items-center gap-4">
                    <button id="executeBtn" onclick="runProcess()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded font-bold transition flex items-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-exclamation-triangle mr-2"></i> 清空舊資料並匯入新名單
                    </button>
                    <span class="text-sm text-gray-400"><i class="fas fa-info-circle mr-1"></i> 備忘錄內容將會被清空，請謹慎操作。</span>
                </div>
            </div>

            <div id="logArea" class="bg-black p-4 rounded-lg font-mono text-xs text-green-400 h-64 overflow-y-auto hidden border border-gray-700"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, writeBatch, doc, getDocs, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvo1Q_O9Mxp-N3bbUQlTppXxc_h5Ame-E",
            authDomain: "notes-8be76.firebaseapp.com",
            projectId: "notes-8be76",
            storageBucket: "notes-8be76.firebasestorage.app",
            messagingSenderId: "1036855189662",
            appId: "1:1036855189662:web:4863ff65f63ab00a995b8f",
            measurementId: "G-KMB6Q7VK8Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- 登入 ---
        window.login = () => signInWithPopup(auth, provider).catch(alert);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('actionSection').classList.remove('hidden');
            }
        });

        // --- 即時預覽筆數 ---
        document.getElementById('rawInput').addEventListener('input', function() {
            const lines = this.value.trim().split('\n').filter(line => line.trim() !== '');
            document.getElementById('countPreview').innerText = lines.length;
        });

        // --- 日誌工具 ---
        const log = (msg) => {
            const logArea = document.getElementById('logArea');
            logArea.classList.remove('hidden');
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            logArea.appendChild(p);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- 核心流程 ---
        window.runProcess = async function() {
            const rawText = document.getElementById('rawInput').value.trim();
            if (!rawText) return alert("請先輸入客戶資料！");
            if (!confirm("警告：這將會【永久刪除】資料庫中所有的舊客戶與備忘錄，並建立新名單。\n\n確定要執行嗎？")) return;

            const btn = document.getElementById('executeBtn');
            btn.disabled = true;
            btn.innerText = "處理中...";
            document.getElementById('logArea').innerHTML = '';

            try {
                // 1. 解析資料
                log("正在解析輸入資料...");
                const lines = rawText.split('\n');
                const newClients = [];
                
                lines.forEach(line => {
                    // 自動切割：支援 "代號 名稱" (中間空格) 或 "代號,名稱" (逗號)
                    let parts = line.trim().split(/[\s,]+/); 
                    if (parts.length >= 2) {
                        const code = parts[0].trim();
                        const name = parts[1].trim(); // 取第二個部分當名字
                        if(code && name) newClients.push({ code, name });
                    }
                });

                log(`解析完成，共 ${newClients.length} 筆新客戶。`);

                // 2. 清空舊資料 (Clients & Memos)
                log("正在清空舊資料庫 (這可能需要幾秒鐘)...");
                await deleteCollection("clients");
                await deleteCollection("memos");
                log("舊資料已清空。");

                // 3. 寫入新資料 (使用 Batch 批次寫入加速)
                log("開始寫入新客戶資料...");
                const batchSize = 400; // Firestore 限制一次 500 筆
                let batch = writeBatch(db);
                let count = 0;
                let totalWritten = 0;

                for (const client of newClients) {
                    const ref = doc(db, "clients", client.code); // 使用代號當 ID
                    batch.set(ref, {
                        code: client.code,
                        name: client.name,
                        createdAt: serverTimestamp(),
                        latestMemoDate: new Date('2000-01-01') // 初始時間
                    });
                    
                    count++;
                    if (count >= batchSize) {
                        await batch.commit();
                        totalWritten += count;
                        log(`已寫入 ${totalWritten} 筆...`);
                        batch = writeBatch(db);
                        count = 0;
                    }
                }
                
                if (count > 0) {
                    await batch.commit();
                    totalWritten += count;
                }

                log("🎉 全部完成！資料庫已更新。");
                alert("成功！舊資料已移除，新名單已建立。");
                btn.innerText = "執行完成";

            } catch (e) {
                console.error(e);
                log(`❌ 發生錯誤: ${e.message}`);
                alert("發生錯誤，請檢查日誌");
                btn.disabled = false;
                btn.innerText = "重試";
            }
        }

        // 輔助：刪除集合中的所有文件
        async function deleteCollection(collectionPath) {
            const q = query(collection(db, collectionPath));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            let count = 0;
            
            snapshot.forEach((doc) => {
                batch.delete(doc.ref);
                count++;
            });

            if (count > 0) {
                await batch.commit();
                log(`已刪除 ${collectionPath}: ${count} 筆`);
            } else {
                log(`${collectionPath} 是空的，略過刪除。`);
            }
        }
        
        // 為了使用 query, collection 需要從 SDK 引入 (上面 import 漏了 query)
        import { query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    </script>
</body>
</html>
