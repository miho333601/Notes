<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±ç®¡ç†å¾Œå° (å‚™ä»½/é‚„åŸ/é‡ç½®)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 p-6 md:p-10">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <div class="flex flex-col md:flex-row justify-between items-center bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-xl">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2"><i class="fas fa-cogs text-blue-500 mr-3"></i>ç³»çµ±ç®¡ç†æ§åˆ¶å°</h1>
                <p class="text-gray-400 text-sm">è«‹è¬¹æ…æ“ä½œï¼Œæ­¤é é¢æ“æœ‰æœ€é«˜æ¬Šé™ã€‚</p>
            </div>
            <div id="loginSection">
                <button onclick="login()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-bold transition shadow-lg flex items-center">
                    <i class="fab fa-google mr-2"></i> ç®¡ç†å“¡ç™»å…¥
                </button>
            </div>
            <div id="userInfo" class="hidden text-right">
                <span class="text-green-400 font-bold" id="userEmail"></span>
                <span class="block text-xs text-gray-500">å·²é€£ç·šè‡³è³‡æ–™åº«</span>
            </div>
        </div>

        <div id="actionSection" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                    <i class="fas fa-save text-9xl text-green-500"></i>
                </div>
                <h2 class="text-xl font-bold text-green-400 mb-4 flex items-center"><i class="fas fa-hdd mr-2"></i> è³‡æ–™åº«å‚™ä»½èˆ‡é‚„åŸ</h2>
                
                <div class="mb-8 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                    <label class="block text-sm font-bold text-gray-300 mb-2">1. å‚™ä»½è³‡æ–™ (Backup)</label>
                    <p class="text-xs text-gray-500 mb-4">å°‡æ‰€æœ‰å®¢æˆ¶èˆ‡å‚™å¿˜éŒ„ä¸‹è¼‰ç‚º JSON æª”æ¡ˆï¼Œå»ºè­°æ¯é€±åŸ·è¡Œä¸€æ¬¡ã€‚</p>
                    <button onclick="backupData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded font-bold transition flex justify-center items-center">
                        <i class="fas fa-download mr-2"></i> ä¸‹è¼‰å®Œæ•´å‚™ä»½æª”
                    </button>
                </div>

                <div class="p-4 bg-gray-900/50 rounded-lg border border-red-900/30">
                    <label class="block text-sm font-bold text-red-300 mb-2">2. ç½é›£é‚„åŸ (Restore)</label>
                    <p class="text-xs text-gray-500 mb-4">æ³¨æ„ï¼šæ­¤æ“ä½œæœƒ <b>å…ˆæ¸…ç©ºç¾æœ‰è³‡æ–™</b>ï¼Œå†åŒ¯å…¥å‚™ä»½æª”ã€‚</p>
                    <input type="file" id="restoreFile" accept=".json" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600 mb-4"/>
                    <button onclick="restoreData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded font-bold transition flex justify-center items-center">
                        <i class="fas fa-upload mr-2"></i> é–‹å§‹é‚„åŸè³‡æ–™
                    </button>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                    <i class="fas fa-list-ol text-9xl text-blue-500"></i>
                </div>
                <h2 class="text-xl font-bold text-blue-400 mb-4 flex items-center"><i class="fas fa-edit mr-2"></i> å¿«é€Ÿå»ºç«‹æ–°åå–®</h2>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-xs text-gray-400 mb-2">è¼¸å…¥æ ¼å¼ï¼š<b>ä»£è™Ÿ åç¨±</b> (ä¸€è¡Œä¸€ç­†)</p>
                        <textarea id="rawInput" class="w-full h-64 bg-gray-900 text-white p-3 rounded border border-gray-600 font-mono text-xs focus:outline-none focus:border-blue-500" placeholder="S001 å°ç©é›»&#10;S002 è¯ç™¼ç§‘..."></textarea>
                        <div class="text-right text-xs text-gray-500">é è¦½ç­†æ•¸ï¼š<span id="countPreview" class="text-white">0</span></div>
                    </div>
                    <button onclick="runResetImport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded font-bold transition">
                        <i class="fas fa-sync-alt mr-2"></i> é‡ç½®ä¸¦åŒ¯å…¥æ–°åå–®
                    </button>
                </div>
            </div>
        </div>

        <div id="logSection" class="hidden bg-black p-4 rounded-xl border border-gray-700 shadow-inner">
            <h3 class="text-gray-500 text-xs font-bold mb-2 uppercase tracking-wider">System Log</h3>
            <div id="logArea" class="h-40 overflow-y-auto font-mono text-xs text-green-400 space-y-1"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, writeBatch, doc, getDocs, setDoc, query, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvo1Q_O9Mxp-N3bbUQlTppXxc_h5Ame-E",
            authDomain: "notes-8be76.firebaseapp.com",
            projectId: "notes-8be76",
            storageBucket: "notes-8be76.firebasestorage.app",
            messagingSenderId: "1036855189662",
            appId: "1:1036855189662:web:4863ff65f63ab00a995b8f",
            measurementId: "G-KMB6Q7VK8Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- ç™»å…¥ ---
        window.login = () => signInWithPopup(auth, provider).catch(alert);
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userEmail').innerText = user.email;
                document.getElementById('actionSection').classList.remove('hidden');
            }
        });

        // --- æ—¥èªŒå·¥å…· ---
        const log = (msg, type = 'info') => {
            const logSection = document.getElementById('logSection');
            const logArea = document.getElementById('logArea');
            logSection.classList.remove('hidden');
            
            const color = type === 'error' ? 'text-red-400' : (type === 'warn' ? 'text-yellow-400' : 'text-green-400');
            const div = document.createElement('div');
            div.className = color;
            div.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ================= åŠŸèƒ½ 1: å‚™ä»½ (Backup) =================
        window.backupData = async function() {
            log("ğŸš€ é–‹å§‹å‚™ä»½è³‡æ–™...");
            try {
                // 1. è®€å– Clients
                log("è®€å–å®¢æˆ¶è³‡æ–™ä¸­...");
                const clientsSnap = await getDocs(collection(db, "clients"));
                const clients = clientsSnap.docs.map(d => d.data());

                // 2. è®€å– Memos
                log("è®€å–å‚™å¿˜éŒ„è³‡æ–™ä¸­...");
                const memosSnap = await getDocs(collection(db, "memos"));
                const memos = memosSnap.docs.map(d => {
                    const data = d.data();
                    // å°‡ Timestamp è½‰æ›ç‚ºå­—ä¸²ï¼Œæ–¹ä¾¿ JSON å„²å­˜
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestampISO = data.timestamp.toDate().toISOString();
                    }
                    return data;
                });

                // 3. æ‰“åŒ…
                const backupPayload = {
                    version: "1.0",
                    exportedAt: new Date().toISOString(),
                    totalClients: clients.length,
                    totalMemos: memos.length,
                    data: {
                        clients: clients,
                        memos: memos
                    }
                };

                // 4. ä¸‹è¼‰æª”æ¡ˆ
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupPayload));
                const downloadAnchorNode = document.createElement('a');
                const fileName = `backup_notes_${new Date().toISOString().slice(0,10)}.json`;
                
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();

                log(`âœ… å‚™ä»½å®Œæˆï¼å·²ä¸‹è¼‰ ${fileName} (å®¢æˆ¶:${clients.length}, å‚™å¿˜:${memos.length})`);

            } catch (e) {
                console.error(e);
                log(`âŒ å‚™ä»½å¤±æ•—: ${e.message}`, 'error');
                alert("å‚™ä»½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™");
            }
        }

        // ================= åŠŸèƒ½ 2: é‚„åŸ (Restore) =================
        window.restoreData = async function() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            if (!file) return alert("è«‹å…ˆé¸æ“‡å‚™ä»½æª” (.json)");

            if (!confirm("âš ï¸ åš´é‡è­¦å‘Š âš ï¸\n\né€™å°‡æœƒã€æ¸…ç©ºç•¶å‰æ‰€æœ‰è³‡æ–™åº«ã€‘ä¸¦é‚„åŸæˆæª”æ¡ˆå…§å®¹ã€‚\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!json.data || !json.data.clients || !json.data.memos) {
                        throw new Error("å‚™ä»½æª”æ ¼å¼éŒ¯èª¤");
                    }

                    log("ğŸš€ é–‹å§‹é‚„åŸç¨‹åº...");
                    log(`å‚™ä»½æª”æ—¥æœŸ: ${json.exportedAt}`);

                    // 1. æ¸…ç©ºèˆŠè³‡æ–™
                    log("æ­£åœ¨æ¸…ç©ºèˆŠè³‡æ–™åº«...");
                    await deleteCollection("clients");
                    await deleteCollection("memos");
                    
                    // 2. å¯«å…¥ Clients
                    log(`æ­£åœ¨é‚„åŸ ${json.data.clients.length} ç­†å®¢æˆ¶è³‡æ–™...`);
                    await batchWrite("clients", json.data.clients, (item) => {
                        // å®¢æˆ¶è³‡æ–™è™•ç† (å¦‚æœéœ€è¦è½‰å‹)
                        if (item.createdAt && typeof item.createdAt === 'string') {
                            // é€™è£¡å¯ä»¥è™•ç†èˆŠè³‡æ–™çš„æ™‚é–“ï¼Œç›®å‰ç°¡å–®è™•ç†
                        }
                        return item;
                    }, true); // Use ID from data (code)

                    // 3. å¯«å…¥ Memos
                    log(`æ­£åœ¨é‚„åŸ ${json.data.memos.length} ç­†å‚™å¿˜éŒ„...`);
                    await batchWrite("memos", json.data.memos, (item) => {
                        // é‡è¦ï¼šå°‡ ISO æ™‚é–“å­—ä¸²è½‰å› Firestore Timestamp
                        if (item.timestampISO) {
                            item.timestamp = Timestamp.fromDate(new Date(item.timestampISO));
                            delete item.timestampISO; // ç§»é™¤æš«å­˜æ¬„ä½
                        }
                        return item;
                    }, false); // Auto ID

                    log("ğŸ‰ é‚„åŸæˆåŠŸï¼è«‹å›åˆ°ä¸»é é¢é‡æ–°æ•´ç†ã€‚");
                    alert("é‚„åŸæˆåŠŸï¼");
                    fileInput.value = ''; // æ¸…ç©ºé¸æ“‡

                } catch (err) {
                    console.error(err);
                    log(`âŒ é‚„åŸå¤±æ•—: ${err.message}`, 'error');
                    alert("é‚„åŸå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼");
                }
            };
            reader.readAsText(file);
        }

        // ================= åŠŸèƒ½ 3: å¿«é€Ÿåå–®é‡ç½® (Reset & Import) =================
        window.runResetImport = async function() {
            const rawText = document.getElementById('rawInput').value.trim();
            if (!rawText) return alert("è«‹è¼¸å…¥è³‡æ–™");
            if (!confirm("ç¢ºå®šè¦æ¸…ç©ºèˆŠè³‡æ–™ä¸¦å»ºç«‹æ–°åå–®å—ï¼Ÿ")) return;

            log("ğŸš€ é–‹å§‹é‡ç½®åå–®...");
            
            // è§£æè³‡æ–™
            const lines = rawText.split('\n');
            const newClients = [];
            lines.forEach(line => {
                let parts = line.trim().split(/[\s,]+/); 
                if (parts.length >= 2) newClients.push({ code: parts[0].trim(), name: parts[1].trim() });
            });

            // æ¸…ç©ºèˆ‡å¯«å…¥
            await deleteCollection("clients");
            await deleteCollection("memos"); // åå–®é‡ç½®é€šå¸¸ä¹Ÿæ„å‘³è‘—æ¸…ç©ºå‚™å¿˜éŒ„ï¼Œè‹¥ä¸æƒ³æ¸…ç©ºå‚™å¿˜éŒ„å¯è¨»è§£æ­¤è¡Œ
            
            await batchWrite("clients", newClients, (client) => ({
                code: client.code,
                name: client.name,
                createdAt: serverTimestamp(),
                latestMemoDate: new Date('2000-01-01')
            }), true);

            log("ğŸ‰ åå–®é‡ç½®å®Œæˆï¼");
            alert("å®Œæˆï¼");
        }

        // ================= å·¥å…·å‡½å¼ (Batch Helpers) =================
        
        async function deleteCollection(collectionPath) {
            const q = query(collection(db, collectionPath));
            const snapshot = await getDocs(q);
            const batchLimit = 400;
            let batch = writeBatch(db);
            let count = 0;
            
            for(const doc of snapshot.docs) {
                batch.delete(doc.ref);
                count++;
                if (count >= batchLimit) { await batch.commit(); batch = writeBatch(db); count = 0; }
            }
            if (count > 0) await batch.commit();
            log(`å·²æ¸…ç©ºé›†åˆ: ${collectionPath}`);
        }

        async function batchWrite(collectionPath, items, transformFn, useCodeAsId = false) {
            const batchLimit = 400;
            let batch = writeBatch(db);
            let count = 0;
            let total = 0;

            for (const item of items) {
                const docData = transformFn ? transformFn(item) : item;
                // å¦‚æœæ˜¯ Clientsï¼Œç”¨ code ç•¶ IDï¼›å¦‚æœæ˜¯ Memosï¼Œè®“ Firebase è‡ªå‹•ç”¢ç”Ÿ ID
                const docRef = useCodeAsId ? doc(db, collectionPath, item.code) : doc(collection(db, collectionPath));
                
                batch.set(docRef, docData);
                
                count++;
                if (count >= batchLimit) {
                    await batch.commit();
                    total += count;
                    log(`å¯«å…¥é€²åº¦... ${total} ç­†`);
                    batch = writeBatch(db);
                    count = 0;
                }
            }
            if (count > 0) await batch.commit();
        }

        // é è¦½è¨ˆæ•¸
        document.getElementById('rawInput').addEventListener('input', function() {
            const lines = this.value.trim().split('\n').filter(line => line.trim() !== '');
            document.getElementById('countPreview').innerText = lines.length;
        });

    </script>
</body>
</html>
